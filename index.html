<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Skeleton RPG – Dragon & Demon King</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<style>
body{margin:0;background:#000;overflow:hidden;font-family:monospace}
canvas{image-rendering:pixelated}
#ui{position:fixed;top:10px;left:10px;color:#fff;z-index:5}
#dialog{
 position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
 width:90%;background:#000;border:2px solid #fff;
 padding:10px;color:#fff;display:none;z-index:10
}
.choice{border:1px solid #fff;padding:6px;margin-top:6px}
</style>
</head>
<body>

<div id="ui"></div>
<div id="dialog"></div>
<canvas id="c"></canvas>

<script>
// ================= CORE =================
const c=document.getElementById("c"),x=c.getContext("2d");
c.width=innerWidth;c.height=innerHeight;

const ui=document.getElementById("ui");
const dialog=document.getElementById("dialog");

addEventListener("resize",()=>{
 c.width=innerWidth;c.height=innerHeight;
});

// ================= GAME STATE =================
const MAGICS=["Ice","Flame","Ground","Water","Magma","Energy"];
let cinematic=false;
let dialogChoice=null;
let zone=0;

// ================= SAVE / LOAD =================
function save(){
 localStorage.setItem("save",JSON.stringify(p));
}
function load(){
 const d=JSON.parse(localStorage.getItem("save"));
 if(d)Object.assign(p,d);
}

// ================= PLAYER =================
const p={
 x:100,y:200,vx:0,vy:0,
 hp:100,mana:100,
 jump:0,
 dash:0,
 magics:[MAGICS[Math.floor(Math.random()*MAGICS.length)]],
 ending:null
};
load();

// ================= INPUT =================
const k={};
onkeydown=e=>k[e.key]=1;
onkeyup=e=>k[e.key]=0;

// ================= ENTITIES =================
const enemies=[];
const npcs=[];
const loot=[];

// ================= SPAWN =================
function spawnEnemy(type,magic,x,y){
 enemies.push({type,magic,x,y,hp: type==="Boss"?300:60});
}
function spawnNPC(text,x,y){
 npcs.push({text,x,y});
}

// Initial world
spawnEnemy("Dragon","Flame",500,200);
spawnEnemy("Dragon","Ice",700,200);
spawnEnemy("Boss","Energy",1200,200);
spawnNPC("Welcome hero.",200,200);

// ================= MAGIC =================
function castMagic(){
 if(p.mana<20)return;
 p.mana-=20;
 loot.push({x:p.x+20,y:p.y,type:"spell",magic:p.magics[0]});
}

// ================= DIALOG =================
function say(t){
 dialog.style.display="block";
 dialog.innerText=t;
 setTimeout(()=>dialog.style.display="none",2000);
}

// ================= DEMON KING CINEMATIC =================
function demonKingCinematic(){
 cinematic=true;
 dialog.style.display="block";
 dialog.innerHTML="So… you defeated the dragons.<br><br>";
 setTimeout(()=>{
  dialog.innerHTML+="Choose your fate:";
  ["Fight","Seal magic","Rule darkness"].forEach((t,i)=>{
   const d=document.createElement("div");
   d.className="choice";
   d.innerText=t;
   d.onclick=()=>chooseEnding(i);
   dialog.appendChild(d);
  });
 },2000);
}

function chooseEnding(i){
 p.ending=i;
 save();
 dialog.style.display="none";
 cinematic=false;
 if(i===0)say("The final battle begins.");
 if(i===1)say("Magic fades. Peace returns.");
 if(i===2)say("Darkness crowns you king.");
}

// ================= LOOP =================
function loop(){
 requestAnimationFrame(loop);
 x.fillStyle="#111";x.fillRect(0,0,c.width,c.height);

 // Movement
 if(!cinematic){
  if(k.a)p.vx=-3;
  if(k.d)p.vx=3;
  if(k.w&&p.jump<2){p.vy=-6;p.jump++}
  if(k[" "]&&p.dash<1){p.vx*=4;p.dash++}
 }

 p.vy+=0.3;
 p.x+=p.vx;p.y+=p.vy;
 p.vx*=0.8;

 if(p.y>300){p.y=300;p.vy=0;p.jump=0;p.dash=0}

 // Player draw
 x.fillStyle="#fff";
 x.fillRect(p.x,p.y,20,30);

 // Enemies
 enemies.forEach((e,i)=>{
  x.fillStyle=e.type==="Boss"?"#f0f":"#f00";
  x.fillRect(e.x,e.y,30,30);
  if(Math.abs(e.x-p.x)<30&&Math.abs(e.y-p.y)<30){
   e.hp-=1;
   if(e.hp<=0){
    if(!p.magics.includes(e.magic))p.magics.push(e.magic);
    if(e.type==="Boss")demonKingCinematic();
    enemies.splice(i,1);
   }
  }
 });

 // Loot / spells
 loot.forEach((l,i)=>{
  x.fillStyle="#0ff";
  l.x+=5;
  x.fillRect(l.x,l.y,10,10);
 });

 // NPCs
 npcs.forEach(n=>{
  x.fillStyle="#0f0";
  x.fillRect(n.x,n.y,20,30);
  if(Math.abs(n.x-p.x)<30)say(n.text);
 });

 ui.innerText=
 `HP:${p.hp} Mana:${p.mana}
 Magic:${p.magics.join(", ")}
 Ending:${p.ending ?? "?"}`;
}
loop();
</script>
</body>
</html>
